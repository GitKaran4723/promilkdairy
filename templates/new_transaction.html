{% extends "base.html" %}
{% block content %}
<style>
  body {
    background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
    font-family: 'Segoe UI', Arial, sans-serif;
  }
  .pad {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 90vh;
    padding: 1rem;
  }
  .card {
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
    padding: 1.8rem;
    max-width: 460px;
    width: 100%;
    transition: box-shadow 0.3s;
  }
  .card:hover { box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.22); }
  .card h3 {
    text-align: center;
    margin-bottom: 0.8rem;
    color: #4f46e5;
    letter-spacing: 1px;
    font-weight: 700;
  }
  .stack { display: flex; flex-direction: column; gap: 0.9rem; }
  label { font-size: 0.95rem; color: #6366f1; font-weight: 600; margin-bottom: 0.2rem; }
  select, input[type="number"], input[type="date"] {
    padding: 0.6rem 0.9rem;
    border: 1.5px solid #c7d2fe;
    border-radius: 8px;
    font-size: 1rem;
    background: #f1f5f9;
    transition: border 0.2s;
    outline: none;
    width: 100%;
    box-sizing: border-box;
  }
  select:focus, input[type="number"]:focus, input[type="date"]:focus {
    border-color: #6366f1; background: #fff;
  }
  .row { display:flex; gap:0.6rem; }
  .row .col { flex:1; }
  button.btn {
    margin-top: 0.5rem;
    padding: 0.85rem 0;
    background: linear-gradient(90deg, #6366f1 0%, #818cf8 100%);
    color: #fff; border: none; border-radius: 8px;
    font-size: 1.05rem; font-weight: 700; cursor: pointer;
    box-shadow: 0 2px 8px 0 rgba(99, 102, 241, 0.10);
    transition: background 0.2s, transform 0.08s;
  }
  #addDraftBtn{
    flex:1;
  }
  button.btn:hover { transform: translateY(-2px) scale(1.02); }
  .small-btn {
    padding: 0.45rem 0.6rem; font-size: 0.9rem; border-radius: 8px;
    background: #fff; border: 1px solid #e5e7eb; cursor:pointer;
  }

  /* Draft list styles */
  .drafts {
    margin-top: 1rem;
    max-height: 210px;
    overflow:auto;
    border-radius: 12px;
    border: 1px dashed #e6ecff;
    padding: 0.6rem;
    background: linear-gradient(180deg,#fff,#fbfdff);
  }
  .draft-item {
    display:flex; align-items:center; justify-content:space-between;
    gap:0.6rem; padding:0.55rem; border-radius:10px;
    background: #ffffff; margin-bottom:0.5rem;
    box-shadow: 0 1px 3px rgba(16,24,40,0.04);
  }
  .draft-meta { font-size:0.92rem; color:#111827; }
  .draft-actions { display:flex; gap:0.4rem; align-items:center; }

  /* Mobile fit */
  @media (max-width:420px) {
    .card { padding:1.1rem; border-radius:14px; }
    .card h3 { font-size:1.05rem; }
    button.btn { font-size:1rem; padding:0.75rem 0; }
  }
</style>

<div class="pad">
  <div class="card">
    <h3>ðŸ§¾ Add Transactions (Draft)</h3>

    <!-- form used only to collect input locally (no immediate server hit) -->
    <div class="stack">
      <label for="customer_id">Customer</label>
      
      <select name="customer_id" id="customer_id" required>
        <option value="">Select a customer</option>
        {% for c in customers %}
        <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>

      <label for="milk_type_id">Milk Type</label>
      <select name="milk_type_id" id="milk_type_id" required>
        {% for m in milk_types %}
        <option value="{{ m.id }}">{{ m.name }}</option>
        {% endfor %}
      </select>

      <div class="row">
        <div class="col">
          <label for="txn_date">Date</label>
          <input type="date" id="txn_date" name="txn_date" value="{{ today }}" required>
        </div>
        <div class="col">
          <label for="session">Session</label>
          <select name="session" id="session">
            <option>Morning</option>
            <option>Evening</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="qty_liters">Quantity (liters)</label>
          <input name="qty_liters" id="qty_liters" type="number" step="0.01" placeholder="e.g. 2.50" required>
        </div>
        <div class="col">
          <label for="fat_value">Fat (optional)</label>
          <input name="fat_value" id="fat_value" type="number" step="0.01" min="3.5" max="11.0" placeholder="e.g. 4.5">
        </div>
      </div>

      <label for="txn_type">Txn Type</label>
      <select name="txn_type" id="txn_type">
        <option value="Sell">Sell (customer â†’ us)</option>
        <option value="Purchase">Purchase (we â†’ customer)</option>
      </select>

      <div style="display:flex; gap:0.6rem; margin-top:0.6rem;">
        <button id="addDraftBtn" class="btn" type="button">Add</button>
        <button id="clearDraftBtn" class="small-btn" type="button">Clear Drafts</button>
      </div>

      <div style="margin-top:0.8rem; display:flex; justify-content:space-between; align-items:center;">
        <strong style="color:#111827">Current Drafts</strong>
        <small style="color:#6b7280">Saved locally â€” refresh safe</small>
      </div>

      <div id="draftsList" class="drafts" aria-live="polite">
        <!-- JavaScript fills this -->
      </div>

      <div style="display:flex; gap:0.6rem; margin-top:0.8rem;">
        <button id="submitAllBtn" class="btn" type="button" style="flex:1">Save all</button>
        <button id="exportJsonBtn" class="small-btn" type="button">Export JSON</button>
      </div>

      <div id="messages" style="margin-top:0.6rem;color:#064e3b;font-weight:600;"></div>
    </div>
  </div>
</div>

<script>
(function(){
  // localStorage key â€” scoped by user id to avoid cross-user collision if same browser
  const userId = "{{ current_user.get_id() }}";
  const STORAGE_KEY = "txns_draft_user_" + userId;
  const draftsListEl = document.getElementById("draftsList");
  const addBtn = document.getElementById("addDraftBtn");
  const clearBtn = document.getElementById("clearDraftBtn");
  const submitAllBtn = document.getElementById("submitAllBtn");
  const exportJsonBtn = document.getElementById("exportJsonBtn");
  const messages = document.getElementById("messages");

  function loadDrafts(){ 
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch(e){ return []; }
  }
  function saveDrafts(arr){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    renderDrafts();
  }
  function renderDrafts(){
    const drafts = loadDrafts();
    draftsListEl.innerHTML = drafts.length ? drafts.map((d, i) => {
      // small readable summary
      const cust = escapeHtml(d.customer_name || ("ID:"+d.customer_id));
      const mt = escapeHtml(d.milk_type_name || ("ID:"+d.milk_type_id));
      const q = Number(d.qty_liters).toFixed(2);
      const fat = d.fat_value ? Number(d.fat_value).toFixed(2) : "-";
      const dt = escapeHtml(d.txn_date);
      return `<div class="draft-item" data-index="${i}">
        <div class="draft-meta">
          <div><strong>${cust}</strong> Â· ${mt}</div>
          <div style="font-size:0.85rem;color:#6b7280">${dt} Â· ${d.session} Â· ${d.txn_type}</div>
          <div style="font-size:0.87rem;color:#374151">Qty: ${q} L Â· Fat: ${fat}</div>
        </div>
        <div class="draft-actions">
          <button class="small-btn btn-delete" data-index="${i}" title="Delete">Delete</button>
        </div>
      </div>`;
    }).join("") : `<div style="color:#6b7280;padding:0.5rem">No drafts yet â€” add transactions above.</div>`;
    // attach delete handlers
    Array.from(document.getElementsByClassName("btn-delete")).forEach(b=>{
      b.addEventListener("click", (ev)=>{
        const idx = Number(ev.currentTarget.dataset.index);
        removeDraft(idx);
      });
    });
  }
  function addDraftFromForm(){
    const customer_id = document.getElementById("customer_id").value;
    const customer_name = document.getElementById("customer_id").selectedOptions[0].text;
    const milk_type_id = document.getElementById("milk_type_id").value;
    const milk_type_name = document.getElementById("milk_type_id").selectedOptions[0].text;
    const txn_date = document.getElementById("txn_date").value;
    const session = document.getElementById("session").value || "Morning";
    const qty_liters_raw = document.getElementById("qty_liters").value;
    const fat_value_raw = document.getElementById("fat_value").value;
    const txn_type = document.getElementById("txn_type").value || "Sell";

    // basic validation
    if(!txn_date){ alert("Please select a date."); return; }
    const qty = Number(qty_liters_raw);
    if(Number.isNaN(qty) || qty <= 0){ alert("Please enter valid quantity (>0)."); return; }
    let fat_value = null;
    if(fat_value_raw !== "") {
      const fv = Number(fat_value_raw);
      if(Number.isNaN(fv) || fv < 0){ alert("Invalid fat value."); return; }
      fat_value = fv;
    }

    const drafts = loadDrafts();
    drafts.push({
      customer_id: Number(customer_id),
      customer_name,
      milk_type_id: Number(milk_type_id),
      milk_type_name,
      txn_date,     // keep yyyy-mm-dd here; server will parse as IST day start
      session,
      qty_liters: qty,
      fat_value: fat_value,
      txn_type
    });
    saveDrafts(drafts);
    messages.textContent = "Draft added â€” remember to 'Save all to server' when ready.";
    setTimeout(()=> messages.textContent = "", 2500);
  }
  function removeDraft(index){
    const drafts = loadDrafts();
    if(index < 0 || index >= drafts.length) return;
    drafts.splice(index,1);
    saveDrafts(drafts);
  }
  function clearDrafts(){
    if(!confirm("Clear all drafts from local storage? This cannot be undone.")) return;
    localStorage.removeItem(STORAGE_KEY);
    renderDrafts();
  }

  function postAllDrafts(){
    const drafts = loadDrafts();
    if(!drafts.length){ alert("No drafts to submit."); return; }
    if(!confirm(`Send ${drafts.length} transactions to server now?`)) return;

    // send as JSON to server; includes CSRF header if present (user may wire it)
    fetch("{{ url_for('batch_transactions') }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        // add X-CSRFToken if needed: "X-CSRFToken": getCookie('csrf_token')
      },
      body: JSON.stringify({ transactions: drafts })
    }).then(async res => {
      if(res.ok){
        const data = await res.json().catch(()=>({}));
        localStorage.removeItem(STORAGE_KEY);
        renderDrafts();
        messages.style.color = "#064e3b";
        messages.textContent = data.message || "Saved successfully.";
        setTimeout(()=> messages.textContent = "", 3000);
      } else {
        const err = await res.json().catch(()=>({error: "Server error"}));
        messages.style.color = "#7f1d1d";
        messages.textContent = err.error || "Failed to save. See console.";
        console.error("Batch save failed:", err);
      }
    }).catch(e=>{
      console.error(e);
      messages.style.color = "#7f1d1d";
      messages.textContent = "Network error while sending batch.";
    });
  }

  function exportJson(){
    const drafts = loadDrafts();
    if(!drafts.length){ alert("No drafts to export."); return; }
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(drafts, null, 2));
    const a = document.createElement('a');
    a.setAttribute('href', dataStr);
    a.setAttribute('download', 'transactions_draft.json');
    document.body.appendChild(a); a.click(); a.remove();
  }

  // warn before leaving only if there are unsaved drafts
  window.addEventListener("beforeunload", function(e){
    const drafts = loadDrafts();
    if(drafts.length){
      // modern browsers ignore custom text; returning true triggers prompt
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  // helpers
  function escapeHtml(s){
    if(!s) return "";
    return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  // attach buttons
  addBtn.addEventListener("click", addDraftFromForm);
  clearBtn.addEventListener("click", clearDrafts);
  submitAllBtn.addEventListener("click", postAllDrafts);
  exportJsonBtn.addEventListener("click", exportJson);

  // initial render
  renderDrafts();
})();
</script>
{% endblock %}
